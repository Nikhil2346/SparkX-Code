<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Professional Stock Simulator</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial/dist/chartjs-chart-financial.min.js"></script>

<style>
:root{
  --bg: #0f1115;
  --panel: #181a20;
  --card: #1f2128;
  --accent: #00cc66;
  --sell: #ff6600;
  --primary: #1e90ff;
  --text: #e6edf3;
  --text-muted: #a0a4ad;
  --shadow: rgba(0,0,0,0.4);
}

*{ box-sizing:border-box; font-family:'Inter',sans-serif; margin:0; padding:0; }

html, body, #app { height:100%; width:100%; background:var(--bg); color:var(--text); }

#app{ display:flex; gap:20px; padding:20px; }

#left{ width:300px; display:flex; flex-direction:column; }

.start-row{ display:flex; gap:10px; margin-bottom:15px; }
.start-row input{ flex:1; padding:8px; border-radius:6px; border:1px solid #333; background:#111; color:var(--text); font-size:16px; }
.start-row button{ padding:8px 14px; border-radius:6px; border:none; background:linear-gradient(45deg,var(--primary),#0055cc); color:#fff; cursor:pointer; font-weight:600; transition:0.3s; }
.start-row button:hover{ background:linear-gradient(45deg,#0055cc,var(--primary)); }

.meta{ margin-bottom:15px; font-size:15px; color:var(--text-muted); line-height:1.5; }

#companyList{ display:flex; flex-direction:column; gap:10px; }

.compRow{
  display:flex; align-items:center;
  padding:8px 10px; border-radius:8px; background:var(--card); box-shadow:0 4px 8px var(--shadow);
  transition: transform 0.2s;
}
.compRow:hover{ transform: translateY(-2px); }

.colorBox{
  width:16px; height:16px; border-radius:4px; margin-right:6px; cursor:pointer;
}

.abbr{
  width:50px; cursor:pointer; font-weight:600;
}

.compRow .price{ font-weight:600; font-size:14px; min-width:80px; }
.compRow button{ padding:6px 10px; border-radius:6px; font-weight:600; cursor:pointer; border:none; transition:0.3s; }
.compRow .buy{ background:var(--accent); color:#000; }
.compRow .buy:hover{ filter:brightness(1.1); }
.compRow .sell{ background:var(--sell); color:#000; }
.compRow .sell:hover{ filter:brightness(1.1); }
.compRow .shares{ font-size:14px; color:var(--text-muted); margin-left:auto; }

#nextDay, #allGraphBtn{
  margin-top:10px; padding:10px; border-radius:8px; border:none; background:linear-gradient(45deg,var(--primary),#0055cc);
  color:#fff; font-weight:600; font-size:14px; cursor:pointer; width:100%; transition:0.3s;
}
#nextDay:hover, #allGraphBtn:hover{ background:linear-gradient(45deg,#0055cc,var(--primary)); }

#leaderboardWrap{
  margin-top:20px; background:var(--card); padding:12px; border-radius:10px; box-shadow:0 4px 10px var(--shadow);
}
#leaderboard th, #leaderboard td{ padding:8px; text-align:left; font-size:14px; }
#leaderboard th{ color:var(--accent); font-weight:600; cursor:pointer; }
#leaderboard tbody tr:nth-child(even){ background: rgba(255,255,255,0.05); }
#leaderboard tbody tr:hover{ background: rgba(0,204,102,0.1); cursor:pointer; }

#resetLeaderboard{
  margin-top:10px; padding:8px; width:100%; border:none; border-radius:6px; background:#ff4444; color:#fff; font-weight:600; cursor:pointer; transition:0.3s;
}
#resetLeaderboard:hover{ background:#ff2222; }

#right{ flex:1; display:flex; flex-direction:column; gap:12px; }

.controls{ height:40px; }
.controls select{ padding:8px; border-radius:6px; border:1px solid #333; background:#111; color:var(--text); font-size:15px; }

#chartWrap{ flex:1; min-height:480px; background:var(--card); border-radius:12px; padding:10px; box-shadow:0 4px 12px var(--shadow); }

canvas{ width:100%; height:100%; }

@media(max-width:900px){
  #app{ flex-direction:column; }
  #left{ width:100%; }
}
</style>
</head>
<!-- Scenario Modal -->
<div id="scenarioModal" class="modal" aria-hidden="true" tabindex="-1">
  <div class="modal-overlay" data-close></div>

  <div class="modal-content scenario-content" role="dialog" aria-modal="true" tabindex="0">
    <button id="scenarioClose" class="modal-close" aria-label="Close">&times;</button>
    <h2>2008 Crash Scenario</h2>
    <p>This will apply a market crash multiplier to the latest prices.</p>
    <div class="modal-actions">
      <button id="scenarioStart">Start the Simulation</button>
      <button id="scenarioCancel">Cancel</button>
    </div>
  </div>
</div>

<body>
<!-- Scenario Popup -->

<script src="config.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const startBtn = document.getElementById('startBtn');
  const modal = document.getElementById('scenarioModal');
  const modalStart = document.getElementById('scenarioStart');
  const modalClose = document.getElementById('scenarioClose');
  const content = modal.querySelector('.scenario-content');

  if (!startBtn || !modal || !modalStart || !modalClose) {
    console.warn('Modal: missing elements (check IDs).');
    return;
  }

  function showModal() {
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
    document.body.classList.add('modal-open');
    setTimeout(()=>content.focus(), 40);
  }
  function hideModal() {
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    document.body.classList.remove('modal-open');
    startBtn.focus();
  }

  // When user clicks main Start button, show the modal.
  startBtn.addEventListener('click', function(ev) {
    ev.preventDefault();
    // if config.js still has a direct start listener, stop it from firing.
    if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();
    showModal();
  });

  // When user confirms the scenario, apply crash then call startGame() from config.js
  modalStart.addEventListener('click', function() {
    hideModal();
    if (typeof window.applyScenarioCrash === 'function') {
      window.applyScenarioCrash(0.5); // 50% drop â€” change multiplier if you want
    } else {
      console.warn('applyScenarioCrash() not found in config.js');
    }
    if (typeof window.startGame === 'function') {
      window.startGame();
    } else {
      console.warn('startGame() not found in config.js');
    }
  });

  modalClose.addEventListener('click', hideModal);
  modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('show')) hideModal(); });
});
</script>


<!-- 2008 Scenario Modal -->
<div id="scenarioModal" class="scenario-modal" aria-hidden="true">
  <div class="scenario-content" role="dialog" aria-labelledby="scenarioTitle" tabindex="-1">
    <button id="scenarioClose" class="scenario-close" aria-label="Close dialog">&times;</button>
    <h2 id="scenarioTitle">ðŸ“‰ Welcome to 2008</h2>
    <p>
      The housing bubble has burst, banks are collapsing, and panic is spreading.
      Your goal: Survive the crash and maybe even make a profit!
    </p>
    <div class="scenario-actions">
      <button id="scenarioStart" class="btn-primary">Start the Simulation</button>
    </div>
  </div>
</div>



<div id="app">
  <aside id="left">
    <div class="start-row">
      <input id="username" placeholder="Enter your username" />
      <button id="startBtn">Start</button>
    </div>

    <div class="meta">
      <div id="dayLbl">Day 0 / 20</div>
      <div id="balLbl">Balance: $10,000.00</div>
    </div>

    <div id="companyList"></div>
    <button id="nextDay">Next Day</button>
    <button id="allGraphBtn">Show All Companies</button>

    <div id="leaderboardWrap">
      <table id="leaderboard">
        <thead><tr><th>User</th><th>Net Worth</th></tr></thead>
        <tbody></tbody>
      </table>
      <button id="resetLeaderboard">Reset Leaderboard</button>
    </div>
  </aside>

  <main id="right">
    <div class="controls">
      <select id="selChart">
        <option value="line">Line Chart</option>
        <option value="candlestick">Candlestick Chart</option>
      </select>
    </div>
    <div id="chartWrap">
      <canvas id="chart"></canvas>
    </div>
  </main>
</div>

<script>
// ----- Configuration -----
const COMPANIES = {
  "Apple":150.25,"Microsoft":299.10,"Google":750.50,"Amazon":700.75,
  "Tesla":720.30,"Netflix":590.15,"Facebook":355.40,"Nvidia":220.80,
  "Adobe":630.20,"IBM":140.20
};
const ABBR = { 
  "Apple":"AAPL","Microsoft":"MSFT","Google":"GOOG","Amazon":"AMZN","Tesla":"TSLA",
  "Netflix":"NFLX","Facebook":"FB","Nvidia":"NVDA","Adobe":"ADBE",
  "IBM":"IBM"
};
const START_BALANCE = 10000;
const TOTAL_DAYS = 20;
const PREV_DAYS = 15;
const COLORS = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf','#00cc66','#ff6600'];

// ----- Helpers -----
function rndDelta(v){ return +(v*(1+(Math.random()*0.1-0.05))).toFixed(2); }
function initHistory(p0, days=PREV_DAYS){ const h=[+p0.toFixed(2)]; for(let i=1;i<days;i++) h.push(rndDelta(h[h.length-1])); return h; }

// ----- State -----
let history={}, shares={}, balance=START_BALANCE, dayPlayed=0, user=null, currentCompany=null, ohlc={}, tradeHistory={};
let leaderboard = JSON.parse(localStorage.getItem('lb')||'{}');
for(const k in COMPANIES){ 
  history[k] = initHistory(COMPANIES[k]); 
  shares[k] = 0; 
  ohlc[k] = history[k].map((p,i)=>{const prev=i===0?p:history[k][i-1]; return {o:prev, h:Math.max(prev,p)+Math.random()*5, l:Math.min(prev,p)-Math.random()*5, c:p};});
}

// ----- DOM Elements -----
let companyList, balLbl, dayLbl, startBtn, username, nextDayBtn, selChart, leaderboardBody, allGraphBtn, ctx, chart=null;

// ----- Build Company Rows -----
function buildCompanyRows(){
  companyList.innerHTML=''; let i=0;
  for(const c in COMPANIES){
    const row=document.createElement('div'); row.className='compRow';
    const colorBox=document.createElement('div'); colorBox.className='colorBox'; colorBox.style.background=COLORS[i%COLORS.length]; colorBox.addEventListener('click',()=>{currentCompany=c; drawChart();});
    const abbr=document.createElement('div'); abbr.className='abbr'; abbr.textContent=ABBR[c]; abbr.addEventListener('click',()=>{currentCompany=c; drawChart();});
    const price=document.createElement('div'); price.className='price'; price.dataset.company=c; price.textContent=history[c][history[c].length-1].toFixed(2);
    const buy=document.createElement('button'); buy.className='buy'; buy.textContent='Buy'; buy.addEventListener('click',()=>trade(c,true));
    const sell=document.createElement('button'); sell.className='sell'; sell.textContent='Sell'; sell.addEventListener('click',()=>trade(c,false));
    const sh=document.createElement('div'); sh.className='shares'; sh.id=`shares-${c}`; sh.textContent=shares[c];
    row.append(colorBox,abbr,price,buy,sell,sh); companyList.append(row); i++;
  }
}

// ----- Refresh UI -----
function refreshUI(){
  dayLbl.textContent=`Day ${dayPlayed} / ${TOTAL_DAYS}`;
  balLbl.textContent=`Balance $${balance.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
  for(const c in COMPANIES){
    const el=document.querySelector(`.price[data-company='${c}']`);
    const cur=history[c][history[c].length-1];
    const prev=history[c].length>1?history[c][history[c].length-2]:cur;
    if(el){ el.textContent=cur.toFixed(2); el.style.color = cur>=prev?'#00FF7F':'#FF4500'; }
    const shEl=document.getElementById(`shares-${c}`); if(shEl) shEl.textContent=shares[c];
  }
  drawChart(); refreshLeader();
}

// ----- Refresh Leaderboard -----
function refreshLeader(){
  leaderboardBody.innerHTML='';
  const arr=Object.entries(leaderboard).sort((a,b)=>b[1]-a[1]);
  for(const [u,w] of arr){ 
    const tr=document.createElement('tr'); 
    tr.innerHTML=`<td>${u}</td><td>$${w.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>`; 
    tr.addEventListener('click',()=>openHistory(u));
    leaderboardBody.append(tr); 
  }
}

// ----- Open History -----
function openHistory(username){
  localStorage.setItem("selectedUser", username);
  localStorage.setItem("tradeHistory", JSON.stringify(tradeHistory[username] || []));
  window.location.href="history.html";
}

// ----- Start Game -----
function startGame(){ 
  const n=username.value.trim(); 
  if(!n){ alert('Enter a username'); return; } 
  user=n; username.disabled=true; startBtn.disabled=true;
  if(!(user in leaderboard)) leaderboard[user]=balance; 
  if(!(user in tradeHistory)) tradeHistory[user]=[];
  localStorage.setItem('lb',JSON.stringify(leaderboard)); 
  refreshUI();
}

// ----- Trade -----
function trade(comp,buy){ 
  if(!user){ alert('Start first'); return; } 
  const qty=1; 
  const price=history[comp][history[comp].length-1];
  if(buy){ 
    if(balance<price*qty){ alert('Insufficient funds'); return; } 
    balance-=price*qty; shares[comp]+=qty; 
    tradeHistory[user].push({type:"BUY",company:comp,price,day:dayPlayed});
  }
  else{ 
    if(shares[comp]<qty){ alert('Not enough shares'); return; } 
    balance+=price*qty; shares[comp]-=qty; 
    tradeHistory[user].push({type:"SELL",company:comp,price,day:dayPlayed});
  } 
  refreshUI();
}

// ----- Next Day -----
function nextDay(){ 
  if(!user){ alert('Start first'); return; } 
  if(dayPlayed>=TOTAL_DAYS){ finish(); return; }
  for(const c in COMPANIES){ 
    const last=history[c][history[c].length-1]; 
    const newPrice=rndDelta(last); 
    history[c].push(newPrice); 
    ohlc[c].push({o:last, h:Math.max(last,newPrice)+Math.random()*5, l:Math.min(last,newPrice)-Math.random()*5, c:newPrice}); 
  }
  dayPlayed++; refreshUI();
}

// ----- Finish Game -----
function finish(){ 
  const net=balance+Object.keys(shares).reduce((s,c)=>s+shares[c]*history[c][history[c].length-1],0);
  alert(`Final Net Worth: $${net.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`);
  leaderboard[user]=net; localStorage.setItem('lb',JSON.stringify(leaderboard)); refreshLeader();
}

// ----- Draw Chart -----
function drawChart(){
  if(chart){ chart.destroy(); chart=null; } 
  const type = selChart.value;
  let datasets=[], labels=[];
  if(currentCompany){
    labels=history[currentCompany].map((_,i)=>i+1);
    if(type==='line'){ datasets=[{ label:currentCompany, data:history[currentCompany], borderColor:COLORS[Object.keys(COMPANIES).indexOf(currentCompany)%COLORS.length], backgroundColor:'transparent', tension:0.15 }]; }
    else if(type==='candlestick'){ datasets=[{ label:currentCompany, data:ohlc[currentCompany], type:'candlestick' }]; labels=undefined; }
  } else {
    labels=Array.from({length:history[Object.keys(COMPANIES)[0]].length},(_,i)=>i+1);
    let i=0; for(const c in COMPANIES){ datasets.push({ label:c, data:history[c], borderColor:COLORS[i%COLORS.length], backgroundColor:'transparent', tension:0.15 }); i++; }
  }
  chart=new Chart(ctx,{ type:type==='line'?'line':'candlestick', data:{labels,datasets}, options:{
    responsive:true, maintainAspectRatio:false,
    plugins:{ legend:{position:'right', labels:{boxWidth:10,font:{size:10}}} },
    scales:{ x:{ grid:{color:'rgba(255,255,255,0.12)'}, ticks:{color:'white'} }, y:{ grid:{color:'rgba(255,255,255,0.12)'}, ticks:{color:'white'} } }
  }});
}

// ----- Event Listeners -----
document.addEventListener('DOMContentLoaded',()=>{ 
  companyList=document.getElementById('companyList'); 
  balLbl=document.getElementById('balLbl'); 
  dayLbl=document.getElementById('dayLbl'); 
  startBtn=document.getElementById('startBtn'); 
  username=document.getElementById('username'); 
  nextDayBtn=document.getElementById('nextDay'); 
  selChart=document.getElementById('selChart'); 
  leaderboardBody=document.querySelector('#leaderboard tbody'); 
  allGraphBtn=document.getElementById('allGraphBtn');
  const canvas=document.getElementById('chart'); ctx=canvas.getContext('2d');
  buildCompanyRows(); refreshUI();
  startBtn.addEventListener('click',startGame);
  nextDayBtn.addEventListener('click',nextDay);
  selChart.addEventListener('change',drawChart);
  allGraphBtn.addEventListener('click',()=>{currentCompany=null; drawChart();});
  document.getElementById('resetLeaderboard').addEventListener('click',()=>{ if(confirm('Reset leaderboard?')){ leaderboard={}; localStorage.removeItem('lb'); refreshLeader(); alert('Leaderboard reset!'); } });
});
</script>
</body>
</html>
